name: Post Deployment Tests

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment'
        required: true
        type: string
      aws_region:
        description: 'AWS Region'
        required: true
        type: string
      project_name:
        description: 'Project Name'
        required: true
        type: string
      api_id :
        description: 'API ID of the  API Gateway'
        required: true
        type: string
    outputs:
      validation_passed: 
        description: 'Whether post deployment tests passed'
        value: ${{ jobs.post-deployment-tests.outputs.validation_passed }}

permissions:
  id-token: write
  contents: read

jobs:
  post-deployment-tests:
    environment: ${{ inputs.environment }}
    runs-on: ubuntu-latest
    outputs:
      validation_passed: ${{ steps.run_postman_tests.outputs.validation_passed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Newman
        run: npm install -g newman

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Retrieve Cognito Token
        run: |
          TOKEN=$(./tests/getToken.sh)
          echo "TOKEN=$TOKEN" >> $GITHUB_ENV

      - name: Get invoke url of API Gateway 
        run: |
          INVOKE_HOST="${{ inputs.api_id }}.execute-api.${{ inputs.aws_region }}.amazonaws.com"
          echo "INVOKE_HOST=$INVOKE_HOST" >> $GITHUB_ENV
        
      - name: Run Postman tests
        id: run_postman_tests
        run: |
          newman run tests/postman/${{ inputs.project_name }}.postman_collection.json \
          -e tests/postman/${{ inputs.environment }}.postman_environment.json \
          --env-var "bearer_token=${{ env.TOKEN }}" \
          --env-var "host=${{ env.INVOKE_HOST }}" \
          -r cli,json \
          --reporter-json-export tests/postman/reports/${{ inputs.environment }}-report.json
        
          # Check status codes from report
          FAILED_REQUESTS=$(jq -r '.run.executions[] | select(.response.code >= 300 or .response.code < 200) | .item.name' tests/postman/reports/${{ inputs.environment }}-report.json)
          
          if [ ! -z "$FAILED_REQUESTS" ]; then
            echo "Failed requests found:"
            echo "$FAILED_REQUESTS"
            echo "validation_passed=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "All requests passed with 2xx status codes"
            echo "validation_passed=true" >> $GITHUB_OUTPUT
          fi
